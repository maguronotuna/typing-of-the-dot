<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Typing of the Dot - Phaser版</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
</head>
<body style="margin: 0; background: #000;">
<script>
  let wordPairs = [];

  async function loadWords() {
    const res = await fetch('https://maguronotuna.github.io/typing-of-the-dot/words.json');
    wordPairs = await res.json();
  }

  class TitleScene extends Phaser.Scene {
    constructor() {
      super('TitleScene');
    }
    create() {
      this.add.text(400, 200, 'Typing of the Dot', { fontSize: '32px', fill: '#0f0' }).setOrigin(0.5);
      this.add.text(400, 250, '~ Fight the Pixel Undead ~', { fontSize: '16px', fill: '#ccc' }).setOrigin(0.5);
      const startText = this.add.text(400, 350, 'ゲーム開始 ▶︎', { fontSize: '24px', fill: '#0ff' }).setOrigin(0.5).setInteractive();

      startText.on('pointerdown', () => {
        this.scene.start('GameScene');
      });
    }
  }

  class GameScene extends Phaser.Scene {
    constructor() {
      super('GameScene');
    }

    init() {
      this.score = 0;
      this.timeLeft = 30;
      this.currentWord = '';
      this.previousWord = '';
      this.typed = '';
    }

    create() {
      this.wordText = this.add.text(400, 200, '', { fontSize: '32px', fill: '#0f0' }).setOrigin(0.5);
      this.meaningText = this.add.text(400, 250, '', { fontSize: '20px', fill: '#ccc' }).setOrigin(0.5);
      this.inputText = this.add.text(400, 300, '', { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);
      this.scoreText = this.add.text(20, 20, 'スコア: 0', { fontSize: '18px', fill: '#0ff' });
      this.timerText = this.add.text(650, 20, '残り時間: 30秒', { fontSize: '18px', fill: '#ff0' });

      this.time.addEvent({ delay: 1000, callback: this.updateTimer, callbackScope: this, loop: true });

      this.input.keyboard.on('keydown', this.handleInput, this);

      this.newWord();
    }

    newWord() {
      let pair;
      do {
        pair = Phaser.Utils.Array.GetRandom(wordPairs);
      } while (pair.word === this.previousWord);
      this.previousWord = pair.word;
      this.currentWord = pair.word;
      this.meaningText.setText(`意味: ${pair.meaning}`);
      this.wordText.setText(this.currentWord);
      this.typed = '';
      this.inputText.setText('');
    }

    handleInput(event) {
      if (this.timeLeft <= 0) return;

      this.typed += event.key.toLowerCase();
      this.inputText.setText(this.typed);

      if (this.typed === this.currentWord) {
        this.score++;
        this.scoreText.setText(`スコア: ${this.score}`);
        this.newWord();
      }
    }

    updateTimer() {
      this.timeLeft--;
      this.timerText.setText(`残り時間: ${this.timeLeft}秒`);
      if (this.timeLeft <= 0) {
        this.scene.start('ResultScene', { score: this.score });
      }
    }
  }

  class ResultScene extends Phaser.Scene {
    constructor() {
      super('ResultScene');
    }

    init(data) {
      this.finalScore = data.score;
    }

    create() {
      this.add.text(400, 200, 'ゲーム終了！', { fontSize: '32px', fill: '#f00' }).setOrigin(0.5);
      this.add.text(400, 250, `あなたのスコアは ${this.finalScore} 点です！`, { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);
      const restartText = this.add.text(400, 350, 'もう一度 ▶︎', { fontSize: '20px', fill: '#0f0' }).setOrigin(0.5).setInteractive();

      restartText.on('pointerdown', () => {
        this.scene.start('GameScene');
      });
    }
  }

  window.onload = async () => {
    await loadWords();

    const config = {
      type: Phaser.AUTO,
      width: 800,
      height: 600,
      backgroundColor: '#111',
      scene: [TitleScene, GameScene, ResultScene]
    };

    new Phaser.Game(config);
  };
</script>
</body>
</html>
