<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Typing of the Dot - Phaser版</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
</head>
<body style="margin: 0; background: #000;">
<script>
  let wordPairs = [];

  // words.jsonから単語リストを非同期で読み込む
  async function loadWords() {
    const res = await fetch('https://maguronotuna.github.io/typing-of-the-dot/words.json');
    wordPairs = await res.json();
  }

  // タイトルシーン：ゲーム開始前の画面
  class TitleScene extends Phaser.Scene {
    constructor() {
      super('TitleScene');
    }
    create() {
      this.add.text(400, 200, 'Typing of the Dot', { fontSize: '32px', fill: '#0f0' }).setOrigin(0.5);
      this.add.text(400, 250, '~ Fight the Pixel Undead ~', { fontSize: '16px', fill: '#ccc' }).setOrigin(0.5);
      const startText = this.add.text(400, 350, '▶︎ ゲーム開始', { fontSize: '24px', fill: '#0ff' }).setOrigin(0.5).setInteractive();

      startText.on('pointerdown', () => {
        this.scene.start('GameScene');
      });
    }
  }

  // ゲームシーン：タイピングとタイマー管理
  class GameScene extends Phaser.Scene {
    constructor() {
      super('GameScene');
    }

    init() {
      this.score = 0;
      this.timeLeft = 30;
      this.currentWord = '';
      this.previousWord = '';
      this.typed = '';
    }

    create() {
      this.wordText = this.add.text(400, 200, '', { fontSize: '32px', fill: '#0f0' }).setOrigin(0.5);
      this.meaningText = this.add.text(400, 250, '', { fontSize: '20px', fill: '#ccc' }).setOrigin(0.5);
      this.inputText = this.add.text(400, 300, '', { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);
      this.scoreText = this.add.text(20, 20, 'スコア: 0', { fontSize: '18px', fill: '#0ff' });
      this.timerText = this.add.text(650, 20, '残り時間: 30秒', { fontSize: '18px', fill: '#ff0' });

      // 1秒ごとにタイマーを更新
      this.time.addEvent({ delay: 1000, callback: this.updateTimer, callbackScope: this, loop: true });
      // キーボード入力を監視
      this.input.keyboard.on('keydown', this.handleInput, this);

      this.newWord();
    }

    newWord() {
      // 直前の単語と被らないようランダムな単語を選択
      let pair;
      do {
        pair = Phaser.Utils.Array.GetRandom(wordPairs);
      } while (pair.word === this.previousWord);
      this.previousWord = pair.word;
      this.currentWord = pair.word;
      this.meaningText.setText(`意味: ${pair.meaning}`);
      this.wordText.setText(this.currentWord);
      this.typed = '';
      this.inputText.setText('');
    }

    handleInput(event) {
      if (this.timeLeft <= 0) return;

      const key = event.key;

      // 制御キーは無視
      if (key === 'Shift' || key === 'Control' || key === 'Alt' || key === 'Meta') return;

      // Backspaceで文字を削除
      if (key === 'Backspace') {
        this.typed = this.typed.slice(0, -1);
        this.inputText.setText(this.typed);
        return;
      }

      // Enterは無視
      if (key === 'Enter') return;

      // 通常の文字入力（小文字に統一）
      this.typed += key.toLowerCase();
      this.inputText.setText(this.typed);

      // 入力が一致すればスコアを更新し、次の単語へ
      if (this.typed === this.currentWord) {
        this.score++;
        this.scoreText.setText(`スコア: ${this.score}`);
        this.newWord();
      }
    }

    updateTimer() {
      this.timeLeft--;
      this.timerText.setText(`残り時間: ${this.timeLeft}秒`);
      if (this.timeLeft <= 0) {
        this.scene.start('ResultScene', { score: this.score });
      }
    }
  }

  // リザルトシーン：ゲーム終了時の結果表示
  class ResultScene extends Phaser.Scene {
    constructor() {
      super('ResultScene');
    }

    init(data) {
      this.finalScore = data.score;
    }

    create() {
      this.add.text(400, 200, 'ゲーム終了！', { fontSize: '32px', fill: '#f00' }).setOrigin(0.5);
      this.add.text(400, 250, `あなたのスコアは ${this.finalScore} 点です！`, { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);
      const restartText = this.add.text(400, 350, '▶︎ もう一度プレイ', { fontSize: '20px', fill: '#0f0' }).setOrigin(0.5).setInteractive();

      restartText.on('pointerdown', () => {
        this.scene.start('GameScene');
      });
    }
  }

  // ページ読み込み完了後、単語リストを読み込みPhaserゲームを起動
  window.onload = async () => {
    await loadWords();
    const config = {
      type: Phaser.AUTO,
      width: 800,
      height: 600,
      backgroundColor: '#111',
      scene: [TitleScene, GameScene, ResultScene]
    };
    new Phaser.Game(config);
  };
</script>
</body>
</html>
